============================= test session starts ==============================
platform linux -- Python 3.11.2, pytest-8.4.1, pluggy-1.6.0
rootdir: /opt/gregor_zwanziger
configfile: pyproject.toml
plugins: anyio-4.12.0
collected 9 items

tests/unit/test_model_metric_fallback.py FF.FFFFFF                       [100%]

=================================== FAILURES ===================================
_______ TestForecastMetaFallbackFields.test_fallback_model_field_exists ________

self = <test_model_metric_fallback.TestForecastMetaFallbackFields object at 0x7fb7c991fc50>

    def test_fallback_model_field_exists(self) -> None:
        meta = _make_meta()
>       assert hasattr(meta, 'fallback_model')
E       AssertionError: assert False
E        +  where False = hasattr(ForecastMeta(provider=<Provider.OPENMETEO: 'OPENMETEO'>, model='meteofrance_arome', run=datetime.datetime(2026, 2, 16, 0, 0, tzinfo=datetime.timezone.utc), grid_res_km=1.3, interp='grid_point', stations_used=[]), 'fallback_model')

tests/unit/test_model_metric_fallback.py:76: AssertionError
______ TestForecastMetaFallbackFields.test_fallback_metrics_field_exists _______

self = <test_model_metric_fallback.TestForecastMetaFallbackFields object at 0x7fb7c991d050>

    def test_fallback_metrics_field_exists(self) -> None:
        meta = _make_meta()
>       assert hasattr(meta, 'fallback_metrics')
E       AssertionError: assert False
E        +  where False = hasattr(ForecastMeta(provider=<Provider.OPENMETEO: 'OPENMETEO'>, model='meteofrance_arome', run=datetime.datetime(2026, 2, 16, 0, 0, tzinfo=datetime.timezone.utc), grid_res_km=1.3, interp='grid_point', stations_used=[]), 'fallback_metrics')

tests/unit/test_model_metric_fallback.py:81: AssertionError
__________ TestFindFallbackModel.test_finds_fallback_for_arome_coords __________

self = <test_model_metric_fallback.TestFindFallbackModel object at 0x7fb7c991dad0>

    def test_finds_fallback_for_arome_coords(self) -> None:
        """AROME at Mallorca should fall back to ICON-EU or ECMWF."""
        from providers.openmeteo import OpenMeteoProvider, AVAILABILITY_CACHE_PATH
    
        # Write a fake cache with AROME missing cape, icon_eu having it
        cache = {
            "probe_date": date.today().isoformat(),
            "models": {
                "meteofrance_arome": {"available": ["temperature_2m"], "unavailable": ["cape", "visibility"]},
                "icon_eu": {"available": ["temperature_2m", "cape", "visibility"], "unavailable": []},
                "ecmwf_ifs04": {"available": ["temperature_2m", "cape"], "unavailable": ["visibility"]},
            }
        }
        AVAILABILITY_CACHE_PATH.parent.mkdir(parents=True, exist_ok=True)
        AVAILABILITY_CACHE_PATH.write_text(json.dumps(cache))
    
        provider = OpenMeteoProvider()
>       result = provider._find_fallback_model("meteofrance_arome", 39.7, 2.6, ["cape", "visibility"])
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'OpenMeteoProvider' object has no attribute '_find_fallback_model'

tests/unit/test_model_metric_fallback.py:116: AttributeError
____________ TestFindFallbackModel.test_returns_none_without_cache _____________

self = <test_model_metric_fallback.TestFindFallbackModel object at 0x7fb7c991ded0>

    def test_returns_none_without_cache(self) -> None:
        """No cache → no fallback."""
        from providers.openmeteo import OpenMeteoProvider, AVAILABILITY_CACHE_PATH
    
        # Remove cache if exists
        if AVAILABILITY_CACHE_PATH.exists():
            AVAILABILITY_CACHE_PATH.unlink()
    
        provider = OpenMeteoProvider()
>       result = provider._find_fallback_model("meteofrance_arome", 39.7, 2.6, ["cape"])
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'OpenMeteoProvider' object has no attribute '_find_fallback_model'

tests/unit/test_model_metric_fallback.py:132: AttributeError
___________________ TestMergeFallback.test_fills_none_fields ___________________

self = <test_model_metric_fallback.TestMergeFallback object at 0x7fb7c990f810>

    def test_fills_none_fields(self) -> None:
        from providers.openmeteo import OpenMeteoProvider
    
        primary = _make_timeseries(cape=None, visibility=None)
        fallback = _make_timeseries(model="icon_eu", cape=500.0, visibility=10000.0)
    
        provider = OpenMeteoProvider()
>       filled = provider._merge_fallback(primary, fallback, ["cape", "visibility"])
                 ^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'OpenMeteoProvider' object has no attribute '_merge_fallback'

tests/unit/test_model_metric_fallback.py:151: AttributeError
______________ TestMergeFallback.test_does_not_overwrite_existing ______________

self = <test_model_metric_fallback.TestMergeFallback object at 0x7fb7c990f290>

    def test_does_not_overwrite_existing(self) -> None:
        from providers.openmeteo import OpenMeteoProvider
    
        primary = _make_timeseries(cape=200.0, visibility=None)
        fallback = _make_timeseries(model="icon_eu", cape=500.0, visibility=10000.0)
    
        provider = OpenMeteoProvider()
>       provider._merge_fallback(primary, fallback, ["cape", "visibility"])
        ^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'OpenMeteoProvider' object has no attribute '_merge_fallback'

tests/unit/test_model_metric_fallback.py:163: AttributeError
____________ TestFooterFallbackInfo.test_html_footer_shows_fallback ____________

self = <test_model_metric_fallback.TestFooterFallbackInfo object at 0x7fb7c990fe90>

    def test_html_footer_shows_fallback(self) -> None:
        from formatters.trip_report import TripReportFormatter
    
        seg = self._make_segment_data(fallback_model="icon_eu", fallback_metrics=["cape", "visibility"])
        formatter = TripReportFormatter()
        report = formatter.format_email([seg], "Test Trip", "morning")
    
>       assert "fallback" in report.email_html.lower()
E       assert 'fallback' in '<!doctype html>\n<html>\n<head>\n    <meta charset="utf-8">\n    <meta name="viewport" content="width=device-width, i...   generated: 2026-02-16 13:56 utc | data: openmeteo (meteofrance_arome)\n        </div>\n    </div>\n</body>\n</html>'
E        +  where '<!doctype html>\n<html>\n<head>\n    <meta charset="utf-8">\n    <meta name="viewport" content="width=device-width, i...   generated: 2026-02-16 13:56 utc | data: openmeteo (meteofrance_arome)\n        </div>\n    </div>\n</body>\n</html>' = <built-in method lower of str object at 0x1c0211f0>()
E        +    where <built-in method lower of str object at 0x1c0211f0> = '<!DOCTYPE html>\n<html>\n<head>\n    <meta charset="utf-8">\n    <meta name="viewport" content="width=device-width, i...   Generated: 2026-02-16 13:56 UTC | Data: openmeteo (meteofrance_arome)\n        </div>\n    </div>\n</body>\n</html>'.lower
E        +      where '<!DOCTYPE html>\n<html>\n<head>\n    <meta charset="utf-8">\n    <meta name="viewport" content="width=device-width, i...   Generated: 2026-02-16 13:56 UTC | Data: openmeteo (meteofrance_arome)\n        </div>\n    </div>\n</body>\n</html>' = TripReport(trip_id='test-trip', trip_name='Test Trip', report_type='morning', generated_at=datetime.datetime(2026, 2, ...erated: 2026-02-16 13:56 UTC\nData: openmeteo (meteofrance_arome)', sms_text=None, triggered_by='schedule', changes=[]).email_html

tests/unit/test_model_metric_fallback.py:217: AssertionError
___________ TestFooterFallbackInfo.test_plain_footer_shows_fallback ____________

self = <test_model_metric_fallback.TestFooterFallbackInfo object at 0x7fb7c990de50>

    def test_plain_footer_shows_fallback(self) -> None:
        from formatters.trip_report import TripReportFormatter
    
        seg = self._make_segment_data(fallback_model="icon_eu", fallback_metrics=["cape", "visibility"])
        formatter = TripReportFormatter()
        report = formatter.format_email([seg], "Test Trip", "morning")
    
>       assert "fallback" in report.email_plain.lower()
E       AssertionError: assert 'fallback' in 'test trip - morning report\n16.02.2026\n\n━━ segment 1: 08:00–10:00 | 5.0 km | ↑100m → 200m ━━\n  time   temp   feels...------------------------------------------------\ngenerated: 2026-02-16 13:56 utc\ndata: openmeteo (meteofrance_arome)'
E        +  where 'test trip - morning report\n16.02.2026\n\n━━ segment 1: 08:00–10:00 | 5.0 km | ↑100m → 200m ━━\n  time   temp   feels...------------------------------------------------\ngenerated: 2026-02-16 13:56 utc\ndata: openmeteo (meteofrance_arome)' = <built-in method lower of str object at 0x1bdabca0>()
E        +    where <built-in method lower of str object at 0x1bdabca0> = 'Test Trip - Morning Report\n16.02.2026\n\n━━ Segment 1: 08:00–10:00 | 5.0 km | ↑100m → 200m ━━\n  Time   Temp   Feels...------------------------------------------------\nGenerated: 2026-02-16 13:56 UTC\nData: openmeteo (meteofrance_arome)'.lower
E        +      where 'Test Trip - Morning Report\n16.02.2026\n\n━━ Segment 1: 08:00–10:00 | 5.0 km | ↑100m → 200m ━━\n  Time   Temp   Feels...------------------------------------------------\nGenerated: 2026-02-16 13:56 UTC\nData: openmeteo (meteofrance_arome)' = TripReport(trip_id='test-trip', trip_name='Test Trip', report_type='morning', generated_at=datetime.datetime(2026, 2, ...erated: 2026-02-16 13:56 UTC\nData: openmeteo (meteofrance_arome)', sms_text=None, triggered_by='schedule', changes=[]).email_plain

tests/unit/test_model_metric_fallback.py:227: AssertionError
=========================== short test summary info ============================
FAILED tests/unit/test_model_metric_fallback.py::TestForecastMetaFallbackFields::test_fallback_model_field_exists
FAILED tests/unit/test_model_metric_fallback.py::TestForecastMetaFallbackFields::test_fallback_metrics_field_exists
FAILED tests/unit/test_model_metric_fallback.py::TestFindFallbackModel::test_finds_fallback_for_arome_coords
FAILED tests/unit/test_model_metric_fallback.py::TestFindFallbackModel::test_returns_none_without_cache
FAILED tests/unit/test_model_metric_fallback.py::TestMergeFallback::test_fills_none_fields
FAILED tests/unit/test_model_metric_fallback.py::TestMergeFallback::test_does_not_overwrite_existing
FAILED tests/unit/test_model_metric_fallback.py::TestFooterFallbackInfo::test_html_footer_shows_fallback
FAILED tests/unit/test_model_metric_fallback.py::TestFooterFallbackInfo::test_plain_footer_shows_fallback
========================= 8 failed, 1 passed in 0.26s ==========================
